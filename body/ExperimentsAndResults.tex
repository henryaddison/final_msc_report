\chapter{Experiments \& Results}\label{chapter:experiments}
\paragraph{Opening paragraph}
This chapter covers what experiments were run to test the performance of the different types of cox control policies. Schedules were created for these experiments with different numbers of boats and different delays between boat launch. Data were collect for simulation runs of each of theses schedules using different control policies. These data were then analysed from different perspectives to determine the relative strengths and weaknesses of each type of control policy.

\section{Overview of experiments run}
  For each experiment the simulation was run with a variety of
  differing starting parameters. Each experiment then examined a
  different aspect of the boat's behaviour. The sets of simulation
  parameters used for experiments are described next. Then there is a
  brief overview of the experiments carried out.

  \subsection{Simulation Parameters}
  For the experiments, the simulation was setup according to the
  parameters associated with a single row in the
  simulation\_parameters table. These parameters are the control
  policy, the random seed and the launch schedule to use. The launch
  schedule is made of up lists of parameters for each boat to be
  launched. These are the launch tick, desired gear, the speed
  multiplier and the minimum distance to cover for each boat in the
  schedule. These parameters are described in more detail in Section \ref{software:experiment:db}.
  
  The launch schedules were created by specifying a number of boats
  and a fixed delay between each boat launch. Each boat was assigned a
  desired gear between 1 and 10 uniformly at random. The speed
  multiplier was fixed at 0.5 (corresponding to a top speed of 5m/s,
  which matched the fastest time set by crew racing the course on
  April 28th 2012). The distance to cover was fixed at 5000m which is
  roughly equivalent to a outing going to the lock and back (5400m in
  the simulation's version of the Cam). It is important to set this
  quite high so that control policies are not rewarded for spinning on
  launch and immediately landing with going anywhere. There are 16 broadly different types of schedules. There is a one-off schedule where just one boat is launched. There are schedules where the number of boats was either 10, 20 or 30 and the delay between boat launches was 1, 2, 3, 5 or 10 minutes (60, 120, 180, 300, 600 ticks respectively).  For each of these 15 schedule types with more than one boat, 5 different versions were created with a different random assignment of desired gear. This was to ensure experimental results were not determined by any specific selection desired speed (e.g. imagine launching the boats in descending order of desired gear, any reasonable set of policies would likely give the same outcome of boats processing forwards and never coming into contact).
  
  From these schedules sets of simulation parameters were created
  using a fixed random seed with each of the 5 different control
  policies and each of the 76 schedules. 5 random seeds were used to
  create 5 otherwise identical sets of 380 simulation parameters. This
  was to make sure a specific random seed (which affects the boat
  chosen at random to escape first from a crash) did not affect the
  results excessively.

  All simulation runs were restricted to 14400 ticks. This corresponds
  to a 4 hour session. This was to ensure no run took too long. Any
  boats that had not landed when 14400 ticks is reached would be left
  stranded. This may be unfair on boats launched towards the end but
  it should not matter when comparing policies as it is the same for all.
  
  \subsection{Details looked at in each experiment}
  Experiments were run to look at how each control policy performed in
  different areas. These experiments are summarized briefly below. In
  the following sections they are then described in more depth along
  with the data.

  \begin{itemize}
    \item{Single boat}
    The simplest experiment examined the control policy in the case
    that only one boat was launched. This is almost a debugging
    exercise to check that none of the control policies does anything
    odd. However, it is still useful to rule out completely hopeless policies.
  
    \item{Outing completion}
    The different control policies are examined to determine which
    one's are best at enabling coxes to cover their required distance
    and return to the boat house.
    
    \item{Safety}
    The different control policies are examined to determine which is
    safest by looking at the crashes that occur for each policy.

    \item{Following outing plan}
    The different control policies are examined to determine which is
    best at helping a boat stick to the cox's desired gear.
  \end{itemize}

  \subsection{Data analysis}
  The SQL queries used to extract the data used in each experiment can be found in Appendix \ref{appendix:sql}. In the details about each experiment to follow the queries used will be referenced from there.

\section{Single boat}
  The single boat experiment is a very simple experiment. It tests the behaviour of the control policy in the simplest of environments - the river without any other boats as obstructions. It is a lower bound for asserting that a policy enables a cox to achieve its ultimate goal of returning the boat to the boathouse after having covered sufficient distance.
  
  Table \ref{experiments:tab:single_boat} shows the results for running the simulation with different control policies. The RandomChoice policy's land tick is NULL. This means that the cox did not land the boat using the RandomChoice policy. When a cox follows the RandomChoice policy, we would expect a sixth of the actions executed by the cox to be Spin. Therefore a cox makes very little useful forward progress when following the RandomChoice policy and certainly not the 5000m of movement required to be able to land again. The RandomChoice policy does not allow a cox to complete an outing in the simplest of settings and so from now on we shall ignore it.
  
  The other 4 policies successfully enable the cox to complete the outing. The SafetyFocussed, GearFocussed and Overtaking policies all have the same results as we would expect. These policies only behave differently when other boats are around. Otherwise they will accelerate into 2nd gear, spin at the lock, accelerate back to 2nd gear and return to the boat house. The deviation from the desired gear is accounted for by spinning for 60 ticks (when the gear difference will be 2 as the boat is in gear 0 when spinning) and the two ticks when it finishes in gear 1 while accelerating just after launch and spinning.
  
  RandomMovement completes the outing in about half the time of the other policies. This is to be expected as it does not limit itself to 2nd gear but may randomly speed up and slow down at any point. The RandomMovement policy also causes the cox to cover a little more distance in its journey from the boathouse to the lock and back. This is because the policy allows the boat to change lane and so it will cover extra distance laterally as well as forward at some points when changing lane.
    

  \begin{table}[h]
  \centering
  \csvreader[tabular=|l|c|c|c|,
      table head=\hline Control Policy & Tick Landed & Aggregate Gear Difference & Distance Covered\\\hline,
      late after last line=\\\hline]
  {csv/SingleBoatTable.csv}{control_policy=\cp, avg_land_tick=\land, avg_distance_covered=\distance,avg_aggregate_gear_difference=\gear}
  {\cp & \land & \gear & \distance}
  \caption{This table shows the data recorded for a single boat launched at tick 0 with desired gear 2. The results are averaged over 5 runs with different random seeds.}
  \label{experiments:tab:single_boat}
  \end{table}
    
\section{Getting boats back to boat house}
In this experiment we test how well the control policies perform in allowing cox's to successfully complete outings. This is similar to the Single Boat experiment but now we examine the number of successful outing completions using launch schedules with multiple boats.

  \paragraph{Table of \% of each time of brain that got back to boat house}
  Table \ref{experiments:tab:returning_boats_by_policy} shows the per-control-policy proportion of boats launched that managed to return to the boathouse before time ran out (after 14400 ticks). All 4 policies perform pretty well though SafetyFocussed is noticeably worse. This is to be expected as it is the most conservative of the 4 policies when it comes to accelerating.
  \begin{table}[h]
  \centering
  \csvreader[tabular=|l|c|,
      table head=\hline Control Policy & \% boats launched completed outing \\\hline,
      late after last line=\\\hline]
  {csv/CompletionRateByPolicy.csv}{control_policy=\cp, percent_boats_returned=\landed}
  {\cp & \landed}
  \caption{This table shows the percentage of boats completing outings according to control policy.}
  \label{experiments:tab:returning_boats_by_policy}
  \end{table}
  
  Table \ref{experiments:tab:returning_boats_by_schedule} shows the per-schedule proportion of boats launched that manage to complete their outings. This suggests that for boats that fail to complete their outings, it is the schedule that is to blame much more than the policy. There are a couple of clear trends: the more boats launched, the less likely a boat is to complete its outing; and the larger the delay between launches the less likely a boat is to complete its outing.
  \paragraph{Table for how percentages changed with schedule}
  \begin{table}[h]
  \centering
  \csvreader[tabular=|l|c|,
      table head=\hline Schedule Description & \% boats launched completed outing \\\hline,
      late after last line=\\\hline]
  {csv/CompletionRateBySchedule.csv}{name=\name, percent_boats_returned=\landed}
  {\name & \landed}
  \caption{This table shows the percentage of boats completing outings according to the launch schedule of the simulation run}
  \label{experiments:tab:returning_boats_by_schedule}
  \end{table}
  
  \paragraph{See that the 10 minute delay is to blame - not all boats launched, no chance for later boats to get back to boat house no matter how good their control policy}
  This makes sense as the more boats launched and the larger the delay, the less time the later boats launched have to complete their outings. Consider the extreme case, launching 30 boats with a 10 minute delay. In fact on the 14400 tick, the 25th boat gets launched. The simulation then ends immediately so there is no chance for this 25th boat to finish it's outing at all (and the 26th to 30th boats never get launched on this schedule). 
  
  Table \ref{experiments:tab:returning_boats_by_policy_small_delay} is similar to Table \ref{experiments:tab:returning_boats_by_policy} except schedules with longer delays (over 10 minutes) are ruled out. The completion rates for all policies are much healthier. This suggests that even in the more congested environments used in this experiment compared to the single boat, all the policies allow a cox to eventually complete an outing. 
  
  \paragraph{Table of overall percentages excluding 10 minute dealy}
  \begin{table}[h]
  \centering
  \csvreader[tabular=|l|c|,
      table head=\hline Control Policy & \% boats launched completed outing \\\hline,
      late after last line=\\\hline]
  {csv/CompletionRateByPolicySmallDelay.csv}{control_policy=\cp, percent_boats_returned=\landed}
  {\cp & \landed}
  \caption{This table shows the percentage of boats completing outings according to control policy for launch schedules with delays between launch of less than 10 minutes.}
  \label{experiments:tab:returning_boats_by_policy_small_delay}
  \end{table}
  
  Another interesting outcome of this experiment is the most successful policy for coxes completing their outings. This is the RandomMovement policy. I suspect this is because it ignores the cox's desired gear and so a cox with a low desired gear launched late in a simulation are likely to travel much faster than those controlled by a policy that will keep to the desired gear. At the other end, the SafetyFocussed policy is the least successful policy is by a large margin. This suggests the SafetyFocussed is not a wise one to follow when under strict time constraints. This suggests that none of the policies are using the space available on the river to its fullest.
  
\section{Crashes}
This experiment examined how safe the control policies were. The data from the \texttt{crash\_records} table was used as a proxy for safety. First stage we examine the total number of crashes that occurred for each control policy based on the different launch schedules. Then we take a closer look at how bad each crash was.

  \paragraph{graphs of crash no versus delay between boats for varying brains and numbers of boats}
  Figures \ref{experiments:fig:crash_counts_10_launches}, \ref{experiments:fig:crash_counts_20_launches} and \ref{experiments:fig:crash_counts_30_launches} show the number of crashes that occurred on average in simulation runs based on the schedule type. The different lines represent the different control policies.
  
  \begin{figure}
  \begin{center}
    \includegraphics[scale=1]{"images/graphs/Average\space number\space of\space crashes\space per\space control\space policy\space for\space simulation\space runs\space with\space 10\space boats\space launched"}
    \caption{Graphs plotting crash counts against launch delay for the 4 control policies for schedules with 10 boats launched}
    \label{experiments:fig:crash_counts_10_launches}
  \end{center}
  \end{figure}
  
  \begin{figure}
  \begin{center}
    \includegraphics[scale=1]{"images/graphs/Average number of crashes per control policy for simulation runs with 20 boats launched"}
    \caption{Graphs plotting crash counts against launch delay for the 4 control policies for schedules with 20 boats launched}
    \label{experiments:fig:crash_counts_20_launches}
  \end{center}
  \end{figure}
  
  \begin{figure}
  \begin{center}
    \includegraphics[scale=1]{"images/graphs/Average number of crashes per control policy for simulation runs with 30 boats launched"}
    \caption{Graphs plotting crash counts against launch delay for the 4 control policies for schedules with 30 boats launched}
    \label{experiments:fig:crash_counts_30_launches}
  \end{center}
  \end{figure}
  
  \paragraph{Conservative brain is best, unsurprisingly. Reassuring the overtaking brain is better than basic brain - there is an advantage in looking ahead for obstacles. Random movement unsurprisingly bad - with basic brains, faster boats should gradually filter to the front}
  Two trends appear immediately in these graphs. The more boats that are launched, the greater the number of crashes. And the larger the delay between launches, the fewer crashes. These are both intuitive results. With a greater number of boats there are more possibilities for crashes and the simulation runs for longer with boats on the river. A larger delay between launches gives each boat more space between it and the next so there is less scope for crashing.
  
  There is also a clear distinction between the control policies. The SafetyFocussed policy is, reassuringly, the policy with the fewest crashes. This makes sense as it is the control policy which makes the most effort not to crash into a boat. Pleasingly, the Overtaking policy leads to half the number of crashes compared to the GearFocussed policy. This suggests the rules for overtaking do allow the cox to make better use of the space available. Unlike the completion rates experiment, RandomMovement is by far the worst policy. This is perhaps because the RandomMovement policy makes no effort to avoid crashes like SafetyFocussed but also unlike Overtaking and GearFocussed policies it does not guarantee that faster boats will eventually get ahead of slower boats and stop crashing into them. Instead boats will randomly speed up and slow down so that same two boats could crash into each other many times over.

  \paragraph{Speed of crashes, location of crashes}
  Let us take a look next at the nature of crashes that occur for each different control policy. Table \ref{experiments:tab:crash_speeds} compares the average relative speed of each crash.
  \begin{table}[h]
  \centering
  \csvreader[tabular=|l|c|c|,
      table head=\hline Control Policy & Average Number Of Crashes Per Run & Average Relative Speed Per Crash Per Run \\\hline,
      late after last line=\\\hline]
  {csv/CrashStats.csv}{control_policy=\cp, crashes_per_run=\count, speed_per_crash=\speed}
  {\cp & \count & \speed}
  \caption{This table shows the average number of crashes and the relative speed of crashes.}
  \label{experiments:tab:crash_speeds}
  \end{table}
  
\section{Deviation from desired gear}


\section{Future Work}

\paragraph{Currently too reliant on averages. Study the distribution of values. For example, look at the percentiles other than just 50th}

\paragraph{Investigate other parameters, like crash delay. Investigate other launch patterns.}

\paragraph{Simulation runs with a mixture of control policies}
